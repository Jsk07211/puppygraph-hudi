CREATE DATABASE IF NOT EXISTS security_graph LOCATION 's3a://warehouse/security_graph.db';

USE security_graph;

CREATE TABLE IF NOT EXISTS security_graph.Users (
  user_id               BIGINT,
  username              STRING,
  email                 STRING,
  phone                 STRING,
  created_at            TIMESTAMP,
  last_login            TIMESTAMP,
  account_status        STRING,
  authentication_method STRING,
  failed_login_attempts INT
) USING hudi
tblproperties (
   primaryKey = 'user_id'
);

CREATE TABLE IF NOT EXISTS security_graph.InternetGateways (
  internet_gateway_id   BIGINT,
  name                  STRING,
  region                STRING,
  status                STRING
) USING hudi
tblproperties (
   primaryKey = 'internet_gateway_id'
);


CREATE TABLE IF NOT EXISTS security_graph.UserInternetGatewayAccess (
  user_id               BIGINT,
  internet_gateway_id   BIGINT,
  access_level          STRING,
  granted_at            TIMESTAMP,
  expires_at            TIMESTAMP,
  last_accessed_at      TIMESTAMP
) USING hudi
tblproperties (
   primaryKey = 'user_id'
);

CREATE TABLE IF NOT EXISTS security_graph.UserInternetGatewayAccessLog (
  log_id                BIGINT,
  user_id               BIGINT,
  internet_gateway_id   BIGINT,
  access_time           TIMESTAMP
) USING hudi
tblproperties (
   primaryKey = 'log_id'
);

CREATE TABLE IF NOT EXISTS security_graph.VPCs (
  vpc_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'vpc_id'
);

CREATE TABLE IF NOT EXISTS security_graph.InternetGatewayVPC (
  internet_gateway_id BIGINT,
  vpc_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'internet_gateway_id'
);

CREATE TABLE IF NOT EXISTS security_graph.Subnets (
  subnet_id BIGINT,
  vpc_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'subnet_id'
);

CREATE TABLE IF NOT EXISTS security_graph.SecurityGroups (
  security_group_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'security_group_id'
);

CREATE TABLE IF NOT EXISTS security_graph.SubnetSecurityGroup (
  subnet_id BIGINT,
  security_group_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'subnet_id'
);

CREATE TABLE IF NOT EXISTS security_graph.NetworkInterfaces (
  network_interface_id BIGINT,
  subnet_id BIGINT,
  security_group_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'network_interface_id'
);

CREATE TABLE IF NOT EXISTS security_graph.VMInstances (
  vm_instance_id BIGINT,
  network_interface_id BIGINT,
  role_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'vm_instance_id'
);

CREATE TABLE IF NOT EXISTS security_graph.Roles (
  role_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'role_id'
);

CREATE TABLE IF NOT EXISTS security_graph.Resources (
  resource_id BIGINT,
  name STRING
) USING hudi
tblproperties (
   primaryKey = 'resource_id'
);

CREATE TABLE IF NOT EXISTS security_graph.RoleResourceAccess (
  role_id BIGINT,
  resource_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'role_id'
);

CREATE TABLE IF NOT EXISTS security_graph.PublicIPs (
  public_ip_id BIGINT,
  ip_address STRING,
  network_interface_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'public_ip_id'
);

CREATE TABLE IF NOT EXISTS security_graph.PrivateIPs (
  private_ip_id BIGINT,
  ip_address STRING,
  network_interface_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'private_ip_id'
);

CREATE TABLE IF NOT EXISTS security_graph.IngressRules (
  ingress_rule_id BIGINT,
  security_group_id BIGINT,
  protocol STRING,
  port_range STRING,
  source STRING
) USING hudi
tblproperties (
   primaryKey = 'ingress_rule_id'
);

CREATE TABLE IF NOT EXISTS security_graph.IngressRuleInternetGateway (
  ingress_rule_id BIGINT,
  internet_gateway_id BIGINT
) USING hudi
tblproperties (
   primaryKey = 'ingress_rule_id'
);

INSERT INTO security_graph.Users
SELECT
    user_id,
    username,
    email,
    phone,
    CAST(created_at AS TIMESTAMP),
    CAST(last_login AS TIMESTAMP),
    account_status,
    authentication_method,
    failed_login_attempts
FROM parquet.`/parquet_data/Users.parquet`;

INSERT INTO security_graph.InternetGateways
SELECT * FROM parquet.`/parquet_data/InternetGateways.parquet`;

INSERT INTO security_graph.UserInternetGatewayAccess
SELECT
    user_id,
    internet_gateway_id,
    access_level,
    CAST(granted_at AS TIMESTAMP),
    CAST(expires_at AS TIMESTAMP),
    CAST(last_accessed_at AS TIMESTAMP)
FROM parquet.`/parquet_data/UserInternetGatewayAccess.parquet`;

INSERT INTO security_graph.UserInternetGatewayAccessLog
SELECT
    log_id,
    user_id,
    internet_gateway_id,
    CAST(access_time AS TIMESTAMP)
FROM parquet.`/parquet_data/UserInternetGatewayAccessLog.parquet`;

INSERT INTO security_graph.VPCs
SELECT * FROM parquet.`/parquet_data/VPCs.parquet`;

INSERT INTO security_graph.InternetGatewayVPC
SELECT * FROM parquet.`/parquet_data/InternetGatewayVPC.parquet`;

INSERT INTO security_graph.Subnets
SELECT * FROM parquet.`/parquet_data/Subnets.parquet`;

INSERT INTO security_graph.SecurityGroups
SELECT * FROM parquet.`/parquet_data/SecurityGroups.parquet`;

INSERT INTO security_graph.SubnetSecurityGroup
SELECT * FROM parquet.`/parquet_data/SubnetSecurityGroup.parquet`;

INSERT INTO security_graph.NetworkInterfaces
SELECT * FROM parquet.`/parquet_data/NetworkInterfaces.parquet`;

INSERT INTO security_graph.VMInstances
SELECT * FROM parquet.`/parquet_data/VMInstances.parquet`;

INSERT INTO security_graph.Roles
SELECT * FROM parquet.`/parquet_data/Roles.parquet`;

INSERT INTO security_graph.Resources  
SELECT * FROM parquet.`/parquet_data/Resources.parquet`;

INSERT INTO security_graph.RoleResourceAccess  
SELECT * FROM parquet.`/parquet_data/RoleResourceAccess.parquet`;

INSERT INTO security_graph.PublicIPs
SELECT * FROM parquet.`/parquet_data/PublicIPs.parquet`;

INSERT INTO security_graph.PrivateIPs 
SELECT * FROM parquet.`/parquet_data/PrivateIPs.parquet`;

INSERT INTO security_graph.IngressRules 
SELECT * FROM parquet.`/parquet_data/IngressRules.parquet`;

INSERT INTO security_graph.IngressRuleInternetGateway 
SELECT * FROM parquet.`/parquet_data/IngressRuleInternetGateway.parquet`;
